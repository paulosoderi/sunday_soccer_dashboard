<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sunday Soccer Dashboard</title>
<style>
:root{
  --bg:#0b0c10;
  --headerBg:rgba(11,12,16,0.92);
  --card:#12141c;
  --text:#e8eaf0;
  --muted:#a9afc3;
  --line:#23283a;
  --btn:#1a1f2f;
  --btnHover:#2d3653;
  --ctrl:#101423;
  --ctrlText:#e8eaf0;
  --hoverRow:rgba(122,162,255,.06);
  --badgeBg:rgba(255,255,255,0.03);
  --canvasBg:#0f1220;
  --axisText:rgba(233,235,240,0.55);
  --axisLine:rgba(233,235,240,0.18);
  --barPos:rgba(122,162,255,0.85);
  --barNeg:rgba(255,122,122,0.75);

  --pos:#3ddc97;
  --neg:#ff6b6b;
  --neu:#ffd166;
}

:root[data-theme="light"]{
  --bg:#fff8f0;
  --headerBg:rgba(255,248,240,0.92);
  --card:#ffffff;
  --text:#1b1b1f;
  --muted:#6b7280;
  --line:#ecd9c8;
  --btn:#ffe6d7;
  --btnHover:#ffd5bf;
  --ctrl:#fff1e6;
  --ctrlText:#1b1b1f;
  --hoverRow:rgba(255,165,120,.18);
  --badgeBg:rgba(255,165,120,0.12);
  --canvasBg:#fff1e6;
  --axisText:rgba(30,30,40,0.60);
  --axisLine:rgba(30,30,40,0.18);
  --barPos:rgba(70,180,140,0.65);
  --barNeg:rgba(245,110,110,0.60);

  --pos:#1f9d6b;
  --neg:#d94a4a;
  --neu:#c88800;
}

#dataPanel {
  display: none;
}

#playerAchievementsCard {
  display: none;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{padding:18px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--headerBg);backdrop-filter:blur(8px);z-index:2}
h1{font-size:18px;margin:0 0 6px}
.sub{color:var(--muted);font-size:12px}
.wrap{padding:16px;max-width:100%;margin:0 auto}
.grid{display:grid;gap:12px}
.grid.kpis{grid-template-columns:repeat(6,minmax(0,1fr))}
.grid.two{grid-template-columns:1.2fr .8fr}
.grid.twoinverted{grid-template-columns:.8fr 1.2fr}
@media (max-width:980px){
  .grid.twoinverted{ grid-template-columns:1fr }
}
@media(max-width:980px){.grid.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}.grid.two{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .label{color:var(--muted);font-size:12px}
.kpi .value{font-size:22px;font-weight:700;margin-top:6px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{background:var(--btn);color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:var(--btnHover)}
input[type=file]{color:var(--muted)}
select{background:var(--ctrl);color:var(--ctrlText);border:1px solid var(--line);border-radius:10px;padding:8px}
input[type=text]{background:var(--ctrl);color:var(--ctrlText);border:1px solid var(--line);border-radius:10px;padding:8px;outline:none}
input[type=text]::placeholder{color:var(--muted)}

.themeToggle{display:inline-flex;align-items:center;gap:8px}
.switch{width:44px;height:26px;border-radius:999px;border:1px solid var(--line);background:var(--ctrl);position:relative;cursor:pointer;flex:0 0 auto}
.knob{width:20px;height:20px;border-radius:50%;background:var(--card);border:1px solid var(--line);position:absolute;top:2px;left:2px;transition:transform .18s ease}
:root[data-theme="light"] .knob{transform:translateX(18px)}

table{width:100%;border-collapse:collapse;font-size:13px}
/* Weekly scores winner highlighting */
.cell-win  { background: rgba(61, 220, 151, 0.18); }
.cell-loss { background: rgba(255, 107, 107, 0.18); }
.cell-draw { background: rgba(255, 209, 102, 0.18); }
th,td{padding:9px 8px;border-bottom:1px solid var(--line);text-align:left}
th{color:var(--muted);font-weight:600;cursor:pointer;user-select:none}
tr:hover td{background:var(--hoverRow)}
.tag{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono";font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.pos{color:var(--pos);font-weight:700}
.neg{color:var(--neg);font-weight:700}
.neu{color:var(--neu);font-weight:700}
.badge{display:inline-flex;align-items:center;gap:2px;padding:2px 4px;border-radius:999px;border:1px solid var(--line);background:var(--badgeBg)}
canvas{width:100%;height:160px;background:var(--canvasBg);border:1px solid var(--line);border-radius:12px}
.split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:680px){.split{grid-template-columns:1fr}}
@media (max-width: 680px) {
  /* Player leaderboard: hide Goals Pro / Goals Against / Goal Diff on mobile */
  #tblPlayers th:nth-child(10),
  #tblPlayers td:nth-child(10),
  #tblPlayers th:nth-child(11),
  #tblPlayers td:nth-child(11),
  #tblPlayers th:nth-child(12),
  #tblPlayers td:nth-child(12) {
    display: none;
  }
}
@media (max-width: 680px) {
  #tblPlayers th, #tblPlayers td { padding: 7px 6px; }
}

@media (max-width: 680px) {
  /* Pair Synergy: tighten spacing on mobile */
  #tblPairs th,
  #tblPairs td {
    padding: 6px 6px;
    font-size: 12px;
  }

  /* Reduce badge padding inside the table */
  #tblPairs .badge {
    padding: 2px 6px;
    font-size: 11px;
  }
}

/* Recent games coloring */
.game-win  { color: var(--pos); font-weight: 600; }
.game-draw { color: var(--neu); font-weight: 600; }
.game-loss { color: var(--neg); font-weight: 600; }

@media (max-width: 980px) {
  /* Captains KPI takes full row on mobile */
  .grid.kpis .card.kpi:nth-child(5) {
    grid-column: 1 / -1;
  }
}
@media (max-width: 980px) {
  /* Captains KPI takes full row on mobile */
  .grid.kpis .card.kpi:nth-child(6) {
    grid-column: 1 / -1;
  }
}
.kpi-rank{
  list-style:none;
  padding:0;
  margin:6px 0 0;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.kpi-rank li{
  display:flex;
  align-items:baseline;
  gap:8px;
  line-height:1.2;
}

.kpi-rank .rank-1{
  font-size:20px;
  font-weight:800;
}

.kpi-rank .rank-2,
.kpi-rank .rank-3{
  font-size:14px;
  font-weight:600;
  opacity:.85;
}

.kpi-rank .medal{
  width:1.2em;
  text-align:center;
}
.ach-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
  margin-top:10px;
}

.ach{
  background:#0e0e0e;
  border-radius:12px;
  padding:10px 8px;
  text-align:center;
  cursor:pointer;
  border:2px solid #222;
}

.ach.unlocked{
  border-color:#f5c16c;
}

.ach.locked{
  opacity:.35;
  filter:grayscale(1);
}

.ach img{
  width:40px;
  height:40px;
  image-rendering: pixelated;
  margin-bottom:6px;
}

.ach-title{
  font-size:12px;
  font-weight:800;
  line-height:1.1;
  color: white
}

.ach-bar{
  height:6px;
  background:#222;
  border-radius:4px;
  margin-top:6px;
  overflow:hidden;
}

.ach-bar > div{
  height:100%;
  background:linear-gradient(90deg,#b87333,#ffd36a);
}
.ach-modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.ach-modal{
  background:#0e0e0e;
  border:3px solid #f5c16c;
  border-radius:14px;
  width:320px;
  max-width:90%;
  box-shadow:0 0 0 4px #000, 0 12px 40px rgba(0,0,0,.6);
  font-family:inherit;
}

.ach-modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  border-bottom:2px solid #222;
  font-weight:900;
  font-size:14px;
  color:white;
}

.ach-modal-close{
  background:none;
  border:none;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}

.ach-modal-body{
  padding:12px;
  font-size:13px;
  line-height:1.4;
  color:#ddd;
}
/* Icon */
.ach-modal-icon{
  width:56px;
  height:56px;
  display:block;
  margin:6px auto 10px;
  image-rendering:pixelated;
}

/* Rarity glow */
.ach-modal.bronze{
  box-shadow:
    0 0 0 4px #000,
    0 0 16px rgba(184,115,51,.6),
    0 12px 40px rgba(0,0,0,.6);
  border-color:#b87333;
}

.ach-modal.silver{
  box-shadow:
    0 0 0 4px #000,
    0 0 18px rgba(200,200,210,.7),
    0 12px 40px rgba(0,0,0,.6);
  border-color:#cfd8dc;
}

.ach-modal.gold{
  box-shadow:
    0 0 0 4px #000,
    0 0 22px rgba(255,210,90,.9),
    0 12px 40px rgba(0,0,0,.6);
  border-color:#ffd36a;
}

/* Mobile safety */
@media (max-width:480px){
  .ach-modal{
    width:92%;
  }
  .ach-modal-icon{
    width:48px;
    height:48px;
  }
}
@media (max-width: 480px) {

  /* Prevent horizontal overflow globally */
  body {
    overflow-x: hidden;
  }

  /* Player profile stats row */
  .player-profile,
  .profile-stats {
    max-width: 100%;
    overflow-x: hidden;
  }

  /* Impact & Win% values */
  .impact,
  .win-pct {
    font-size: 11px;
    white-space: nowrap;
  }

  .pos,.neu,.neg,.badge {
    font-size: 11px;
  }

  /* If Impact uses icon + number */
  .impact span,
  .win-pct span {
    display: inline-block;
    max-width: 100%;
  }

}

.ev-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-top:8px;
  gap:12px;
}

.ev-right{
  text-align:right;
  min-width:90px;
}

.player-profile-text{
  font-weight:600;
  font-size:16px;
}
.match-has-events:hover td {
  background: rgba(122,162,255,.08);
}

.match-modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.match-modal{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  width:520px;
  max-width:92%;
  box-shadow: 0 12px 40px rgba(0,0,0,.35);
  color:var(--text);
}

#matchModalTitle{
  color:var(--text);
}

.match-modal-close{
  background:none;
  border:none;
  color:var(--text);
  font-size:16px;
  cursor:pointer;
}

.match-modal-body{
  padding:12px;
  color:var(--text);
}
.match-modal-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  color:var(--text);
}

.timeline-wrap{
  position:relative;
  height:360px;
  border:1px solid var(--line);
  border-radius:12px;
  background:transparent;
  overflow:hidden;
  overflow-y:auto;  
  padding-top:28px;  
   padding-bottom:20px; 
}

.timeline-line{
  position:absolute;
  left:50%;
  top:10px;
  bottom:10px;
  width:2px;
  background:var(--axisLine);
}

#matchTimelineEvents{
  position:relative;   /* REQUIRED */
  min-height:1px;
}
/* Event node */
.tl-event{
  position:absolute;
  max-width:46%;
  font-size:12px;
  line-height:1.2;
  /*padding:4px 6px;*/
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--badgeBg);
  color:var(--text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.tl-left{ right:52%; text-align:right; }
.tl-right{ left:52%; text-align:left; }

/* Team pill inside event */
.tl-team{
  display:inline-block;
  font-size:11px;
  font-weight:800;
  padding:2px 6px;
  border-radius:999px;
  border:1px solid var(--line);
  margin-right:6px;
}

.tl-team.black{
  background:rgba(0,0,0,.10);
}

.tl-team.white{
  background:rgba(255,255,255,.18);
}
.timeline-headers{
  position:absolute;
  top:6px;
  left:0;
  right:0;
  display:flex;
  justify-content:space-between;
  pointer-events:none;
  z-index:2;
}

.timeline-header {
    font-size: 12px;
    font-weight: 800;
    padding: 2px 8px;
   
    
    color: var(--text);
    width: 100%;
    
}

.timeline-header.left{
  margin-left:6px;
  border: 1px solid white;
  background: black;
  color: white;
}

.timeline-header.right{
  margin-left:6px;
  border: 1px solid black;
  background: white;
  color: black;
}

@media (max-width:480px){
  .timeline-wrap{
    height:300px;    /* smaller viewport */
  }
}

@media (max-width:480px){
  .match-modal{ width:92%; }
  .timeline-wrap{ height:320px; }
  .tl-event{ font-size:11px; }
}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between; align-items:flex-start;">
    <div>
      <h1>Sunday Soccer Dashboard</h1>
      <div class="sub">v1.2b</div>
    </div>
    <div class="themeToggle" title="Toggle theme (saved on this browser)">
      <span class="small" id="themeLabel">light</span>
      <button class="switch" id="themeToggle" aria-label="Toggle theme"><span class="knob"></span></button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card" id="dataPanel">
    <div class="row">
      <button class="btn" id="useMock">Use embedded mock data</button>
      <span class="tag">or load your files</span>
      <label class="small">player_game.csv <input type="file" id="filePlayers" accept=".csv"></label>
      <label class="small">match_team.csv <input type="file" id="fileMatches" accept=".csv"></label>
      <label class="small">player_match_stats.csv <input type="file" id="fileEvents"  accept=".csv"></label> <!-- NEW (optional) -->

      <button class="btn" id="loadFiles">Load uploaded CSVs</button>
      <span class="mono" id="status"></span>
    </div>  
    <div class="small" style="margin-top:10px;">
        Required columns:
        <span class="mono">player_game: session_id, match_id, match_date, player_id, player_name, team</span>
        <span class="mono" style="margin-left:6px;" title="Optional. Mark the captains each Sunday (one per team). Use 1/0, Y/N, true/false.">(optional: is_captain)</span> ‚Ä¢
        <span class="mono">match_team: session_id, match_id, match_date, team, goals_for, goals_against, result</span>
        <span class="mono" style="margin-left:6px;" title="If result is NO_DATA, the match is excluded from the dashboard.">(NO_DATA rows excluded)</span>
      </div>
    </div>
    <div class="card" >
      <div class="row" style="margin-top:10px;">
        <span class="small" title="Choose whether to view all history, one year, or one session.">View</span>
          <select id="viewMode" title="Filter the dashboard by All history, a specific Year, or a specific Session.">
            <option value="all" selected>All history</option>
            <option value="year" >Year</option>
            <option value="session">Session</option>
        </select>

        <span class="small" id="viewValueLabel" title="Pick which year or session to view. Defaults to the most recent.">Selection</span>
        <select id="viewValue" title="Available years or sessions (most recent selected)." disabled></select>

        <span class="tag" id="activeFilterTag" title="Shows the active filter.">Filter: All history</span>
      </div>
    </div>

  <div class="grid kpis" style="margin-top:12px;">
    <div class="card kpi">
      <div class="label" title="Number of Sundays with a recorded match (within selected filter).">üìÖ Matches</div>
      <div class="value" id="kpiSundays">‚Äî</div>
    </div>
    <div class="card kpi">
      <div class="label"  title="Excludes matches with placeholder scores (1‚Äì0, 0‚Äì1, 1‚Äì1) where full scoring was not tracked.">ü•Ö Avg goals / Sunday</div>
      <div class="value" id="kpiAvgGoals">‚Äî</div>
    </div>
    <div class="card kpi">
      <div class="label" title="Draw rate across team rows (W/D/L per team per match).">‚öñÔ∏è Draw rate</div>
      <div class="value" id="kpiDrawRate">‚Äî</div>
    </div>
    <div class="card kpi">
      <div class="label" title="Close games: share of Sundays where goal difference is ‚â§ 1 (excluding 1-0 and 0-1 placeholder scores).">‚öîÔ∏è Close games (‚â§1 goal)</div>
      <div class="value" id="kpiClose">‚Äî</div>
    </div>

    <div class="card kpi">
      <div class="label" title="Captains within the selected filter (is_captain=1). One line per captain: W-D-L and win%. Hidden unless captain has at least 3 captain games.">üß¢ Captains</div>
      <div class="small" id="kpiCaptainEmpty">‚Äî</div>
      <div id="kpiCaptainList" style="margin-top:8px; display:flex; flex-direction:column; gap:6px;"></div>
    </div>

    <div class="card kpi">
      <div class="label">üèÜTop Scorers</div>
      <ul class="kpi-rank" id="kpiTopScorers"></ul>
      <div class="detail" id="kpiTopScorersDetail"></div>
    </div>

    <div class="card kpi">
      <div class="label">üéØ Top Assist</div>
      <div class="value" id="kpiTopAssist">‚Äî</div>
      <div class="detail" id="kpiTopAssistDetail"></div>
    </div>

    <div class="card kpi">
      <div class="label"
          title="Best win streak (max consecutive wins) among all players in the selected filter.">
        üëë Best streak
      </div>
      <div class="value" id="kpiBestStreak">‚Äî</div>
      <div class="small" id="kpiBestStreakDetail"></div>
    </div>
  </div>

  <div class="grid two" style="margin-top:12px;">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:700;">Player Leaderboard üëë</div>
          <div class="small" title="Click a player to open their profile.">Click a player to open their profile.</div>
        </div>
        <div class="row" style="gap:8px;">
          <span class="small" title="Hide players with fewer games than this in the selected filter.">Min games</span>
          <select id="minGames" title="Hide players with fewer than this many games (selected filter).">
            <option value="0" selected>0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px; overflow:auto;"><table id="tblPlayers"></table></div>
    </div>

    <div class="card" id="playerProfileCard">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:700;">Player Profile üéØ</div>
        </div>
        <div class="row" style="gap:8px;">
          <select id="playerSelect" title="Pick a player to view profile."></select>
        </div>
      </div>

      <div class="split" style="margin-top:10px;">
        <div class="card" style="padding:10px;">
          <div style="font-weight:700; margin-bottom:6px;">üìù Matches</div>
          <div class="small" title="Wins-Draws-Losses in the current filter.">Record</div>
          <div style="font-weight:600; font-size:18px;" id="pWDL">‚Äî</div>
          <div class="small" style="margin-top:8px;" title="Win% in the current filter.">Win%</div>
          <div style="font-weight:600;" id="pWR">‚Äî</div>
          <div class="small" style="margin-top:8px;" title="How many sessions the player participated in (all-time, including current session).">Sessions played</div>
          <div style="font-weight:600;" id="pSessions">‚Äî</div>
        </div>
        <!-- Player actions (event stats) -->
        <div class="card" style="padding:10px;">
          <!-- Header -->
          <div style="display:flex; align-items:baseline; gap:6px; margin-bottom:8px;">
            <div style="font-weight:700;">üë®üèª‚Äçüè´ Individual Stats</div>
            <div class="small" style="color:#999;">
              (<span id="pEvGames">‚Äî</span> Total Tracked games)
            </div>
          </div>

          <!-- Goals -->
          <div class="ev-row">
            <div>
              <div class="small">‚öΩ Goals</div>
              <div class="ev-value" id="pEvGoals">‚Äî</div>
            </div>
            <div class="ev-right">
              <div class="small">Per Game</div>
              <div class="player-profile-text"id="pEvGoalsPg">‚Äî</div>
            </div>
          </div>

          <!-- Assists -->
          <div class="ev-row">
            <div>
              <div class="small">üëü Assists</div>
              <div class="player-profile-text" id="pEvAssists">‚Äî</div>
            </div>
            <div class="ev-right">
              <div class="small">Per Game</div>
              <div class="player-profile-text" id="pEvAssistsPg">‚Äî</div>
            </div>
          </div>

          <!-- 2nd Assists -->
          <div class="ev-row">
            <div>
              <div class="small">2nd Assists</div>
              <div class="player-profile-text" id="pEv2A">‚Äî</div>
            </div>
            <div class="ev-right">
              <div class="small">Per Game</div>
              <div class="player-profile-text" id="pEv2APg">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="card" style="padding:10px;">
            <!-- Team impact (team outcomes while player played) -->
            <div>
              <div style="font-weight:700; margin-bottom:6px;">üëï Team Impact</div>
               <div class="small"      
                    title="Total goals scored and conceded by the team in matches where this player played (current filter)."
                    style="margin-top:8px;">Team Goals (For / Against)</div>
              <div class="player-profile-text"  id="pTeamGoals">‚Äî</div>

              <div class="small" style="margin-top:8px;">Goal diff</div>
              <div class="player-profile-text"  id="pTeamGD">‚Äî</div>

              <div class="small" style="margin-top:8px;" title="Player impact = player win% ‚àí baseline win% in percentage points.">Impact</div>
              <div class="player-profile-text" style="font-size:15px !important" id="pImpact">‚Äî</div>

              <div class="small" id="pImpactNote" style="margin-top:6px; line-height:1.4;">‚Äî</div>
          </div>
        </div>  

          
        </div>
    
      <div class="card" style="margin-top:10px; padding:10px;" id="pStreakCard">
        <div class="small" title="Captain stats within current filter.">Streak record</div>
        <div class="row" style="margin-top:8px;" id="pStreakRow"></div>
      </div>
      <div class="card" style="margin-top:10px; padding:10px;" id="pCaptainCard">
        <div class="small" title="Captain stats within current filter.">Captain record</div>
        <div class="row" id="pCaptainRow" style="margin-top:8px;"></div>
      </div>

      <div class="card" style="margin-top:10px; padding:10px;" id="pRecentGamesCard">
        <div class="small" title="Captain stats within current filter.">Recent games</div>
        <div class="row" style="margin-top:10px; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:700;"></div>
          <div class="small" title="Shows the most recent 10 games for this player. Use pagination to go further back.">Last 10</div>
        </div>
        <div class="row" id="pTimelineControls"></div>
      </div>
      <div class="mono" id="pTimeline" style="margin-top:8px; line-height:1.7; white-space:pre-wrap;">‚Äî</div>
      
    </div id="divAchievements">
       <div class="card" style="margin-top:10px; padding:10px;" id="playerAchievementsCard">
        <div class="label">Achievements</div>
        <div class="ach-grid" id="playerAchievements"></div>
      </div>
   
    </div>     
  </div>

  
  
  <div class="grid twoinverted" style="margin-top:12px;">
     <div class="card">
      <div style="font-weight:700;">Weekly Scores üìÖ</div>
      <div class="row" style="justify-content:space-between; align-items:center; margin-top:10px;">
        <div class="small" id="matchesPagerLabel">‚Äî</div>
        <div class="row" id="matchesPager"></div>
      </div>
      <div style="margin-top:10px; overflow:auto;"><table id="tblMatches"></table></div>
      <div style="margin-top:12px;">
        <div class="small" style="margin-bottom:6px;" title="Bar chart of (Black goals ‚àí White goals) by date.">Goal difference by Sunday (Black perspective)</div>
        <canvas id="chartGD" width="900" height="200"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:700;">Pair Synergy ü§ù</div>
          <div class="small" title="Pairs are computed when two players are on the same team in the same match.">Together win% vs expected win%</div>
        </div>
        <div class="row" style="gap:8px;">
          <select id="pairPlayer"
                  title="Filter pair synergy by player (matches Player A or Player B)."
                  style="min-width:220px;">
            <option value="">All players</option>
          </select>
          <select id="minPairGames" title="Hide player pairs with fewer than this many games together. Synergy becomes meaningful once pairs have played multiple times.">
            <option value="5" selected>Min pair games: 5</option>
            <option value="6">Min pair games: 6</option>
            <option value="7">Min pair games: 7</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px; overflow:auto;"><table id="tblPairs"></table></div>
    </div>

   
  </div>

</div>

<script>
const MOCK_PLAYER_GAME = `session_id,match_id,match_date,player_id,player_name,team,is_captain
S01,2024-11-03,2024-11-03,Alysson,Alysson,Black,1
S01,2024-11-03,2024-11-03,Ivan,Ivan,Black,0
S01,2024-11-03,2024-11-03,Max,Max,White,1
S01,2024-11-03,2024-11-03,Paul,Paul,White,0
S01,2024-11-10,2024-11-10,Alysson,Alysson,White,1
S01,2024-11-10,2024-11-10,Ivan,Ivan,Black,1
S01,2024-11-10,2024-11-10,Max,Max,White,0
S01,2024-11-10,2024-11-10,Paul,Paul,Black,0
S02,2025-10-05,2025-10-05,Alysson,Alysson,Black,1
S02,2025-10-05,2025-10-05,Ivan,Ivan,Black,0
S02,2025-10-05,2025-10-05,Cindy,Cindy,White,1
S02,2025-10-05,2025-10-05,Mel,Mel,White,0
S02,2025-10-12,2025-10-12,Alysson,Alysson,White,0
S02,2025-10-12,2025-10-12,Ivan,Ivan,Black,1
S02,2025-10-12,2025-10-12,Cindy,Cindy,White,1
S02,2025-10-12,2025-10-12,Mel,Mel,Black,0`;

const MOCK_MATCH_TEAM = `session_id,match_id,match_date,team,goals_for,goals_against,result
S01,2024-11-03,2024-11-03,Black,2,1,W
S01,2024-11-03,2024-11-03,White,1,2,L
S01,2024-11-10,2024-11-10,Black,3,3,D
S01,2024-11-10,2024-11-10,White,3,3,D
S02,2025-10-05,2025-10-05,Black,3,2,W
S02,2025-10-05,2025-10-05,White,2,3,L
S02,2025-10-12,2025-10-12,Black,2,2,D
S02,2025-10-12,2025-10-12,White,2,2,D`;

const MOCK_MATCH_EVENTS = `session_id,match_id,Timestamp,Team,second_assist_player_id,assist_player_id,goal_player_id
S02,2025-10-12,2025-10-12 19:14,Black,,Ivan,Alysson
S02,2025-10-12,2025-10-12 19:18,White,,Cindy,Mel
S02,2025-10-12,2025-10-12 19:25,Black,,Alysson,Ivan
S02,2025-10-12,2025-10-12 19:33,Black,,Ivan,Alysson
S02,2025-10-12,2025-10-12 19:40,White,,Mel,Cindy
S02,2025-10-12,2025-10-12 19:48,Black,,Alysson,Ivan
S02,2025-10-12,2025-10-12 19:55,Black,Ivan,Alysson,Ivan
S02,2025-10-12,2025-10-12 20:02,White,,Cindy,Mel
`;

let QUERY_STATE = null;
let QUERY_APPLIED = false;


const MIN_CAPTAIN_GAMES = 3;

const PROFILE_PAGE_SIZE = 10;
const PROFILE_PAGE_BY_PLAYER = new Map();
const MATCHES_PAGE_SIZE = 10;
let MATCHES_PAGE = 0;
let CURRENT_MODEL=null;
let RAW_PLAYER_ROWS=[];
let RAW_MATCH_ROWS=[];
let RAW_EVENT_ROWS = []; 
//helper to populate filters and auxilar in all logic
let idx =[];
let ALLTIME_SESSIONS_BY_PLAYER=new Map();


// --- Remote CSV source (CloudFront recommended)
const CLOUDFRONT_BASE_URL = "https://d297oxwame7tvp.cloudfront.net"; 
const PLAYER_CSV_URL = `${CLOUDFRONT_BASE_URL}/data/player_game.csv`;
const MATCH_CSV_URL  = `${CLOUDFRONT_BASE_URL}/data/match_team.csv`;
const EVENTS_CSV_URL = `${CLOUDFRONT_BASE_URL}/data/match_events.csv`;

const ACHIEVEMENTS = [
  // üéÆ Games Played
  { id:"gp10",  icon:"icons/game_bronze.png", title:"Insert Coin",
    desc:"Play 10 games", target:10, value:p=>p.games },

  { id:"gp50",  icon:"icons/game_silver.png", title:"No-Life Mode",
    desc:"Play 50 games", target:50, value:p=>p.games },

  { id:"gp100", icon:"icons/game_gold.png", title:"Old-School Grinder",
    desc:"Play 100 games", target:100, value:p=>p.games },

  // üèüÔ∏è Sessions
  { id:"s5",  icon:"icons/session_bronze.png", title:"Session New Gen",
    desc:"Play 5 sessions", target:5, value:p=>p.sessionsPlayedAll },

  { id:"s10", icon:"icons/session_silver.png", title:"Session Old Gen",
    desc:"Play 10 sessions", target:10, value:p=>p.sessionsPlayedAll },

  { id:"s15", icon:"icons/session_gold.png", title:"Session Retro Legend",
    desc:"Play 15 sessions", target:15, value:p=>p.sessionsPlayedAll },

  // ‚öΩ Goals
  { id:"g10",  icon:"icons/goal_bronze.png", title:"Pixel Finisher",
    desc:"Score 10 goals", target:10, value:p=>p.evGoals },

  { id:"g50",  icon:"icons/goal_silver.png", title:"16-Bit Striker",
    desc:"Score 100 goals", target:100, value:p=>p.evGoals },

  { id:"g100", icon:"icons/goal_gold.png", title:"Cartridge Cannon",
    desc:"Score 200 goals", target:200, value:p=>p.evGoals },

  // üèÜ Wins (rebalanced)
  { id:"w5",  icon:"icons/win_bronze.png", title:"First Continue",
    desc:"Win 5 games", target:5, value:p=>p.w },

  { id:"w25", icon:"icons/win_silver.png", title:"Boss Slayer",
    desc:"Win 25 games", target:25, value:p=>p.w },

  { id:"w50", icon:"icons/win_gold.png", title:"Final Stage Clear",
    desc:"Win 100 games", target:100, value:p=>p.w }
];


/******* 1- BEGIN LOAD DATA 
Default loads data from CSVs, but for testing purpose you can pass 
mock=true in the query param and that will enable you to use the mock data or upload cvsfor quick test
*/

async function init(){
  // set default view once
  const vm = document.getElementById("viewMode");
  if (vm) vm.value = "all";

  try {
    // choose loader
    if (hasQueryFlag("mock")) {
      await loadFromMock();
    } else{
      await loadFromRemoteCSVs(); // production default
    }

    //populate helper for filters available
     idx = buildFilterIndex(RAW_MATCH_ROWS);

    // AFTER data is guaranteed loaded
    refreshViewControls();

  } catch (e) {
    setStatus("Init failed: " + (e?.message || e));
  }
}

async function loadFromMock(){
  try{
    setStatus("Loading mock data...");
    RAW_PLAYER_ROWS=parseCSV(MOCK_PLAYER_GAME);
    RAW_MATCH_ROWS=parseCSV(MOCK_MATCH_TEAM);
    RAW_EVENT_ROWS  = parseEventsCSV(MOCK_MATCH_EVENTS);

    ALLTIME_SESSIONS_BY_PLAYER=computeSessionsByPlayer(RAW_PLAYER_ROWS);
    setStatus("Loaded mock data.");
  }catch(e){
    setStatus("Error: "+(e?.message||e));
  }
}

async function loadFromUploads(){
  const fP=document.getElementById("filePlayers")?.files?.[0];
  const fM=document.getElementById("fileMatches")?.files?.[0];
  const fE = document.getElementById("fileEvents")?.files?.[0]; 
  if(!fP||!fM||!fE){setStatus("Select both CSV files first.");return;}
  try{
    setStatus("Reading files...");
    const [tP,tM,tE]=await Promise.all([readFileText(fP),readFileText(fM), readFileText(fE)]);
    RAW_PLAYER_ROWS=parseCSV(tP);
    RAW_MATCH_ROWS=parseCSV(tM);
    RAW_EVENT_ROWS=parseCSV(tE);

    ALLTIME_SESSIONS_BY_PLAYER=computeSessionsByPlayer(RAW_PLAYER_ROWS);
    idx = buildFilterIndex(RAW_MATCH_ROWS);
    setStatus("Loaded uploaded data.");
  }catch(e){
    setStatus("Error: "+(e?.message||e));
  }
  // AFTER data is guaranteed loaded
    refreshViewControls();
}

async function loadFromRemoteCSVs(){
  try{
    setStatus("Loading data...");

    const [playerText, matchText, eventsText] = await Promise.all([
      fetch(PLAYER_CSV_URL, { cache: "no-store" }).then(r => {
        if(!r.ok) throw new Error(`player_game.csv load failed (${r.status})`);
        return r.text();
      }),
      fetch(MATCH_CSV_URL, { cache: "no-store" }).then(r => {
        if(!r.ok) throw new Error(`match_team.csv load failed (${r.status})`);
        return r.text();
      }),
      fetch(EVENTS_CSV_URL, { cache: "no-store" }).then(r => {
        if(!r.ok) throw new Error(`match_events.csv load failed (${r.status})`);
        return r.text();
      })

    ]);

    RAW_PLAYER_ROWS = parseCSV(playerText);
    RAW_MATCH_ROWS  = parseCSV(matchText);
    RAW_EVENT_ROWS = parseEventsCSV(eventsText);

    ALLTIME_SESSIONS_BY_PLAYER = computeSessionsByPlayer(RAW_PLAYER_ROWS);
    setStatus("Loaded.");
  }catch(e){
    console.error(e);
    setStatus("Error: " + (e?.message || e));
  }
}

//this is the main function
init()

/******* 1- END LOAD DATA */

function refreshViewControls(){
    tempMode = applyQueryFiltersModeOnce();
    const mode =  tempMode ??  document.getElementById("viewMode")?.value ??  "all";
    const modeDropdown = document.getElementById("viewMode");
    modeDropdown.value = mode;
    const sel  = document.getElementById("viewValue");
    const label= document.getElementById("viewValueLabel");
    if(!sel || !label) return;

    if(mode === "all"){
      sel.innerHTML = "";
      sel.disabled = true;
      label.textContent = "Selection";
      applyFilterAndRender();
    } 

    if(mode === "session"){
      label.textContent = "Session";
      sel.disabled = false;

      const recent = getMostRecentSession(RAW_MATCH_ROWS);
      sel.innerHTML = idx.sessionList
        .map(s=>`<option value="${s}">${s}</option>`)
        .join("");

      // ‚úÖ force default session selection
      sel.value = idx.sessionList.includes(recent)
        ? recent
        : idx.sessionList[idx.sessionList.length - 1];

    } else if(mode === "year"){
      label.textContent = "Year";
      sel.disabled = false;

      const recent = getMostRecentYear(RAW_MATCH_ROWS);
      sel.innerHTML = idx.yearList
        .map(y=>`<option value="${y}">${y}</option>`)
        .join("");

      // ‚úÖ force default year selection
      sel.value = idx.yearList.includes(recent)
        ? recent
        : idx.yearList[idx.yearList.length - 1];
    }
      applyFilterValueOnce();     
      applyFilterAndRender();
    }

function applyFilterAndRender(){
  if(!RAW_PLAYER_ROWS.length || !RAW_MATCH_ROWS.length) return;

  const mode=document.getElementById("viewMode")?.value || "all";
  const val=document.getElementById("viewValue")?.value || "";

  let fPlayers=RAW_PLAYER_ROWS;
  let fMatches=RAW_MATCH_ROWS;
  let tag="All history";

  if(mode==="session"){
    fPlayers=RAW_PLAYER_ROWS.filter(r=>String(r.session_id??"S01").trim()===val);
    fMatches=RAW_MATCH_ROWS.filter(r=>String(r.session_id??"S01").trim()===val);
    tag=`Session: ${val}`;
  } else if(mode==="year"){
    fPlayers=RAW_PLAYER_ROWS.filter(r=>yearOf(r.match_date)===val);
    fMatches=RAW_MATCH_ROWS.filter(r=>yearOf(r.match_date)===val);
    tag=`Year: ${val}`;
  }

  const tagEl=document.getElementById("activeFilterTag");
  if(tagEl){
    tagEl.textContent=`Filter: ${tag}`;
    tagEl.title=`Active filter: ${tag}`;
  }

  MATCHES_PAGE = 0;
  CURRENT_MODEL=buildModel(fPlayers,fMatches,ALLTIME_SESSIONS_BY_PLAYER);

  // Attach event-based stats (goals/assists/2nd assists) if events are loaded
  //const matchIdSet = new Set((CURRENT_MODEL.matchSummaries || []).map(m => m.match_id));
  const matchIdSet = new Set(
   (CURRENT_MODEL.matchSummaries || []).map(m => String(m.match_id).trim())
   );
  const eventAgg = buildEventAgg(RAW_EVENT_ROWS || [], matchIdSet);

  // Matches in the current filter that actually have event data
    const eventMatchIdSet = new Set(
      (RAW_EVENT_ROWS || [])
        .filter(e => matchIdSet.has(String(e.match_id).trim()))
        .map(e => e.match_id)
    );

    // Count event-games per player USING FILTERED DATA
    const eventGamesByPlayer = new Map();

    for (const p of CURRENT_MODEL.playerList || []) {
      const evGames = (p.timeline || []).filter(t =>
        eventMatchIdSet.has(String(t.match_id).trim())
      ).length;

      eventGamesByPlayer.set(p.player_id, evGames);
    }

    (CURRENT_MODEL.playerList || []).forEach(p => {
      const pid = normPid(p.player_id);
      const a = eventAgg.get(pid) || {goals:0,assists:0,secondAssists:0};

      p.evGoals = a.goals;
      p.evAssists = a.assists;
      p.evSecondAssists = a.secondAssists;
      p.evGames = eventGamesByPlayer.get(p.player_id) || 0;
    });
  renderAll(CURRENT_MODEL);
  }

function getQueryParams(){
  const p = new URLSearchParams(window.location.search);
  return {
    player: p.get("player"),
    year: p.get("year"),
    session: p.get("session")
  };
}

function readQueryState(){
  if (QUERY_STATE) return QUERY_STATE;

  const p = new URLSearchParams(window.location.search);
  QUERY_STATE = {
    player: p.get("player"),
    year: p.get("year"),
    session: p.get("session")
  };
  return QUERY_STATE;
}

function applyFilterValueOnce(){
   if (QUERY_APPLIED) return;
  QUERY_APPLIED = true;   

  const q = readQueryState();
  if (!q) return;

  // YEAR from query
  if (q.year && idx.yearList.includes(q.year)) {
    viewMode.value = "year";
    viewValue.value = q.year;
    return;
  }

  // SESSION from query
  if (q.session && idx.sessionList.includes(q.session)) {
    viewMode.value = "session";
    viewValue.value = q.session;
    return;
  }
}

function applyPlayerFilter(){
  const q = readQueryState();
  if (!q) return;
  playerSelect=document.getElementById("playerSelect");

  // Player from query
  if (q.player && playerExists(q.player)){
    playerSelect.value = q.player
    playerSelect.dispatchEvent(new Event("change", { bubbles: true }));

    return;
  }
}

function applyQueryFiltersModeOnce(){
  if (QUERY_APPLIED) return;
  const q = readQueryState();
  if (!q) return;

  if (q.year){
    return "year"
  }else if (q.session){
    return "session"
  }else{
    return "all"
  }
}

function hasQueryFlag(name){
  const v = new URLSearchParams(window.location.search).get(name);
  return v === "1" || v === "true" || v === "yes";
}

function parseCSV(text){
  const raw = String(text ?? "").trim();
  if(!raw) return [];
  const lines = raw.split(/\r?\n/);
  if(!lines.length) return [];
  const header = lines[0].split(",").map(s=>s.trim());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    if(!lines[i].trim()) continue;
    const cols=lines[i].split(",");
    const o={};
    header.forEach((h,idx)=>o[h]=(cols[idx]??"").trim());
    rows.push(o);
  }
  return rows;
}

function normTeam(t){const v=String(t??"").trim().toLowerCase();if(v==="black"||v==="b")return"Black";if(v==="white"||v==="w")return"White";return String(t??"").trim()}
function normResult(r){const v=String(r??"").trim().toUpperCase();return(v==="W"||v==="D"||v==="L"||v==="NO_DATA")?v:v}
function isTruthy(x){const v=String(x??"").trim().toLowerCase();return v==="1"||v==="true"||v==="t"||v==="y"||v==="yes"||v==="captain";}
function toInt(x){const n=Number.parseInt(x,10);return Number.isFinite(n)?n:0}
function pct(x){return (x*100).toFixed(1)+"%"}
function pct0(x){ return Math.round(x*100) + "%"; }
function fmt(x,d=2){return Number.isFinite(x)?x.toFixed(d):"‚Äî"}
function perGame(val, games){return games ? `${fmt(val/games,1)}/pg` : "‚Äî";}
function clsSign(x){if(!Number.isFinite(x))return"";if(x>0)return"pos";if(x<0)return"neg";return"neu"}
function emojiSign(x){if(!Number.isFinite(x))return"";if(x>0)return"üü¢";if(x<0)return"üî¥";return"üü°"}
function signedPP(x){const pp=x*100;return `${pp>=0?"+":""}${fmt(pp,0)}`}
function signedNum(x) {if (x > 0) return `+${x}`; if (x < 0) return `${x}` ;else return  `${x}`;}
function key(...p){return p.join("||")}
function yearOf(dateStr){return String(dateStr||"").slice(0,4)}
function normPid(x){ return String(x ?? "").trim().toLowerCase(); }
function setText(id,val){const el=document.getElementById(id); if(el) el.textContent=val}
function setStatus(msg){const el=document.getElementById("status"); if(el) el.textContent=msg}

function dateKey(d){
  if(!d) return -Infinity;
  const s = String(d).trim();

  // YYYY-MM-DD (safe lexicographically)
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return Date.parse(s);

  // MM/DD/YYYY (or M/D/YYYY)
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){
    const mm = +m[1], dd = +m[2], yy = +m[3];
    return Date.parse(`${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`);
  }

  // Fallback
  const t = Date.parse(s);
  return Number.isFinite(t) ? t : -Infinity;
}

function parseEventsCSV(text){
  const rows = parseCSV(text);

  return rows.map(r => ({
    session_id: String(r.session_id ?? "").trim() || "S01",
    match_id: String(r.match_id ?? "").trim(),
    match_date: String(r.match_date ?? "").trim(), // optional if you add later
    timestamp: String(r.Timestamp ?? r.timestamp ?? "").trim(),
    team: normTeam(r.Team),
    second_assist_player_id: normPid(r.second_assist_player_id),
    assist_player_id: normPid(r.assist_player_id),
    goal_player_id: normPid(r.goal_player_id)
  }));
}

function buildEventAgg(rows, matchIdSet){
  const agg = new Map();

  for (const r of rows || []) {
    if (!matchIdSet.has(String(r.match_id).trim())) continue;

    // GOAL
    if (r.goal_player_id) {
      const pid = normPid(r.goal_player_id);
      const a = agg.get(normPid(pid)) || { goals:0, assists:0, secondAssists:0 };
      a.goals++;
      agg.set(normPid(pid), a);
    }

    // ASSIST
    if (r.assist_player_id) {
      const pid = normPid(r.assist_player_id);
      const a = agg.get(normPid(pid)) || { goals:0, assists:0, secondAssists:0 };
      a.assists++;
      agg.set(normPid(pid), a);
    }

    // SECOND ASSIST
    if (r.second_assist_player_id) {
      const pid = normPid(r.second_assist_player_id);
      const a = agg.get(normPid(pid)) || { goals:0, assists:0, secondAssists:0 };
      a.secondAssists++;
      agg.set(normPid(pid), a);
    }
  }

  return agg;
}

function pairMatchesPlayer(aId, bId, playerId){
  if(!playerId) return true;
  return aId === playerId || bId === playerId;
}

function drawBarChart(canvas,labels,values){
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cs=getComputedStyle(document.documentElement);
  const axisLine=cs.getPropertyValue("--axisLine").trim()||"rgba(233,235,240,0.18)";
  const axisText=cs.getPropertyValue("--axisText").trim()||"rgba(233,235,240,0.55)";
  const barPos=cs.getPropertyValue("--barPos").trim()||"rgba(122,162,255,0.85)";
  const barNeg=cs.getPropertyValue("--barNeg").trim()||"rgba(255,122,122,0.75)";

  const padL=44,padR=10,padT=10,padB=34;
  const innerW=w-padL-padR,innerH=h-padT-padB;
  const maxAbs=Math.max(1,...values.map(v=>Math.abs(v)));
  const midY=padT+innerH/2;

  ctx.strokeStyle=axisLine;
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(padL,midY);
  ctx.lineTo(w-padR,midY);
  ctx.stroke();

  ctx.fillStyle=axisText;
  ctx.font="12px ui-monospace, Menlo, Consolas";
  ctx.fillText(String(maxAbs),8,padT+10);
  ctx.fillText("0",20,midY+4);
  ctx.fillText(String(-maxAbs),2,padT+innerH+10);

  const n=values.length,gap=6;
  const barW=Math.max(6,(innerW-gap*(n-1))/n);

  for(let i=0;i<n;i++){
    const v=values[i];
    const x=padL+i*(barW+gap);
    const barH=(Math.abs(v)/maxAbs)*(innerH/2-6);
    const y=v>=0?(midY-barH):midY;

    ctx.fillStyle=v>=0?barPos:barNeg;
    ctx.fillRect(x,y,barW,barH);

    ctx.save();
    ctx.translate(x+barW/2,h-8);
    ctx.rotate(-0.6);
    ctx.fillStyle=axisText;
    ctx.font="11px ui-monospace, Menlo, Consolas";
    ctx.textAlign="right";
    //ctx.fillText(labels[i],0,0);
    ctx.restore();
  }
}

function computeSessionsByPlayer(allPlayerRows){
  const m=new Map();
  for(const r of allPlayerRows){
    const pid=normPid( String(r.player_id??"").trim());
    if(!pid) continue;
    const sid=String(r.session_id??"S01").trim()||"S01";
    if(!m.has(pid)) m.set(pid,new Set());
    m.get(pid).add(sid);
  }
  const out=new Map();
  for(const [pid,set] of m.entries()) out.set(pid,set.size);
  return out;
}

function buildModel(playerRows,matchRows,allTimeSessionsByPlayer){
  const matchIdx=new Map(),matchesById=new Map();

  const normalized=matchRows
    .map(r=>({
      session_id:String(r.session_id??"S01").trim()||"S01",
      match_id:String(r.match_id??"").trim(),
      match_date:String(r.match_date??"").trim(),
      team:normTeam(r.team),
      goals_for:toInt(r.goals_for),
      goals_against:(String(r.goals_against??"").trim()===""?null:toInt(r.goals_against)),
      result:normResult(r.result)
    }))
    .filter(r=>r.result!=="NO_DATA");

  const byMatch=new Map();
  for(const r of normalized){
    if(!byMatch.has(r.match_id)) byMatch.set(r.match_id,[]);
    byMatch.get(r.match_id).push(r);
  }
  for(const rows of byMatch.values()){
    const b=rows.find(x=>x.team==="Black"), w=rows.find(x=>x.team==="White");
    if(b&&w){
      if(b.goals_against===null) b.goals_against=w.goals_for;
      if(w.goals_against===null) w.goals_against=b.goals_for;
    }
  }

  for(const r of normalized){
    const mr={
      session_id:r.session_id,
      match_id:r.match_id,
      match_date:r.match_date,
      year:yearOf(r.match_date),
      team:r.team,
      goals_for:r.goals_for,
      goals_against:(r.goals_against??0),
      result:r.result
    };
    matchIdx.set(key(mr.match_id,mr.team),mr);
    if(!matchesById.has(mr.match_id)) matchesById.set(mr.match_id,[]);
    matchesById.get(mr.match_id).push(mr);
  }

  const plays=playerRows.map(pr=>{
    const mid=String(pr.match_id??"").trim();
    const tm=normTeam(pr.team);
    const mr=matchIdx.get(key(mid,tm));
    return {
      session_id:String(pr.session_id??"S01").trim()||"S01",
      match_id:mid,
      match_date:String(pr.match_date??"").trim(),
      year:yearOf(pr.match_date),
     // player_id:String(pr.player_id??"").trim(),
      player_id: normPid(pr.player_id ?? ""),
      player_name:String(pr.player_name??"").trim(),
      team:tm,
      is_captain:isTruthy(pr.is_captain),
      joined:mr||null
    };
  });

  const teamRows=normalized.map(r=>({session_id:r.session_id,match_id:r.match_id,match_date:r.match_date,team:r.team,gf:r.goals_for,ga:(r.goals_against??0),res:r.result}));
  const base={
    teamGames:teamRows.length,
    wins:teamRows.filter(x=>x.res==="W").length,
    draws:teamRows.filter(x=>x.res==="D").length,
    losses:teamRows.filter(x=>x.res==="L").length
  };
  const baseWinRate=base.teamGames?base.wins/base.teamGames:0;

  const matchIds=Array.from(matchesById.keys()).sort();
  const matchSummaries=matchIds.map(id=>{
    const rows=matchesById.get(id);
    const b=rows.find(r=>r.team==="Black"), w=rows.find(r=>r.team==="White");
    const gd=b?(b.goals_for-b.goals_against):0;
    const total=(b?.goals_for??0)+(w?.goals_for??0);
    const isPlaceholder10 = ((b?.goals_for===1 && b?.goals_against===0) || (b?.goals_for===0 && b?.goals_against===1));
    return {
      match_id:id,
      match_date:(b?.match_date||w?.match_date||""),
      session_id:(b?.session_id||w?.session_id||"S01"),
      year:(b?.year||w?.year||yearOf(b?.match_date||w?.match_date||"")),
      black_gf:b?.goals_for??0,
      white_gf:w?.goals_for??0,
      black_res:b?.result??"",
      gd_black:gd,
      totalGoals:total,
      close:(Math.abs(gd)<=1 && !isPlaceholder10)
    };
  });

  const players=new Map();
  const captains=new Map();

  for(const p of plays){
    if(!p.joined) continue;
    if(!players.has(p.player_id)){
      players.set(p.player_id,{player_id:p.player_id,player_name:p.player_name,games:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,timeline:[]});
    }
    const a=players.get(p.player_id);
    a.games++;
    if(p.joined.result==="W") a.w++;
    else if(p.joined.result==="D") a.d++;
    else if(p.joined.result==="L") a.l++;
    a.gf+=p.joined.goals_for;
    a.ga+=p.joined.goals_against;
    a.gd+=(p.joined.goals_for-p.joined.goals_against);
    a.timeline.push({match_id: p.match_id, match_date:(p.joined.match_date||p.match_date),team:p.team,res:p.joined.result,gf:p.joined.goals_for,ga:p.joined.goals_against,session_id:p.joined.session_id,is_captain:p.is_captain});

    if(p.is_captain){
      if(!captains.has(p.player_id)) captains.set(p.player_id,{player_id:p.player_id,player_name:p.player_name,games:0,w:0,d:0,l:0});
      const c=captains.get(p.player_id);
      c.games++;
      if(p.joined.result==="W") c.w++;
      else if(p.joined.result==="D") c.d++;
      else if(p.joined.result==="L") c.l++;
    }
  }

  const captainById=captains;

  const playerList=Array.from(players.values()).map(p=>{
    const winRate=p.games?p.w/p.games:0;
    const impact=winRate-baseWinRate;

    p.timeline.sort((a,b)=>a.match_date<b.match_date?1:-1);

    let currentStreak=0, bestStreak=0;
    for(const t of p.timeline){
      if(t.res==="W"){ currentStreak++; bestStreak=Math.max(bestStreak,currentStreak); }
      else break;
    }
    // üèÜ BEST STREAK (overall ‚Äì all history within filter)
    let runAll = 0;
    let bestAll = 0;

    // scan oldest ‚Üí newest
    for (const t of [...p.timeline].reverse()) {
      if (t.res === "W") {
        runAll++;
        if (runAll > bestAll) bestAll = runAll;
      } else {
        runAll = 0;
      }
    }

    bestStreak = bestAll;

    // üìÖ BEST STREAK END DATE (most recent)
    let run = 0;
    let bestStreakEndDate = null;

    for (const t of [...p.timeline].reverse()) {
      if (t.res === "W") {
        run++;
        if (run === bestStreak) {
          bestStreakEndDate = t.match_date; // most recent by design
        }
      } else {
        run = 0;
      }
    }


    let currentCold=0, bestCold=0;
    for(const t of p.timeline){
      if(t.res==="L"){ currentCold++; bestCold=Math.max(bestCold,currentCold); }
      else break;
    }
    let lrun=0;
    for(const t of [...p.timeline].reverse()){
      if(t.res==="L"){ lrun++; bestCold=Math.max(bestCold,lrun); }
      else lrun=0;
    }

    const sessionsPlayedAll = allTimeSessionsByPlayer?.get(p.player_id) ?? 1;

    const cap = captainById.get(p.player_id);
    const captainGames = cap?.games ?? 0;
    const captainW = cap?.w ?? 0;
    const captainD = cap?.d ?? 0;
    const captainL = cap?.l ?? 0;

    return {
      ...p,
      winRate,impact,
      totalGF:p.gf,totalGA:p.ga,totalGD:p.gd,
      currentStreak,bestStreak,bestStreakEndDate,currentCold,bestCold,
      sessionsPlayedAll,
      captainGames,captainW,captainD,captainL
    };
  });

  const group=new Map();
  for(const p of plays){
    if(!p.joined) continue;
    const k=key(p.match_id,p.team);
    if(!group.has(k)) group.set(k,[]);
    group.get(k).push(p);
  }
  const pWin=new Map(playerList.map(p=>[p.player_id,p.winRate]));
  const pName=new Map(playerList.map(p=>[p.player_id,p.player_name]));

  const pairs=new Map();
  for(const members of group.values()){
    for(let i=0;i<members.length;i++){
      for(let j=i+1;j<members.length;j++){
        const a=members[i], b=members[j];
        const ida=a.player_id, idb=b.player_id;
        const pairId=ida<idb?key(ida,idb):key(idb,ida);
        if(!pairs.has(pairId)) pairs.set(pairId,{a:ida<idb?ida:idb,b:ida<idb?idb:ida,games:0,w:0,d:0,l:0});
        const pr=pairs.get(pairId);
        pr.games++;
        const res=a.joined.result;
        if(res==="W") pr.w++;
        else if(res==="D") pr.d++;
        else if(res==="L") pr.l++;
      }
    }
  }

  const pairList=Array.from(pairs.values()).map(x=>{
    const winRate=x.games?x.w/x.games:0;
    const expected=((pWin.get(x.a)??0)+(pWin.get(x.b)??0))/2;
    const synergy=winRate-expected;
    return {
      a_id:x.a,a_name:pName.get(x.a)??x.a,
      b_id:x.b,b_name:pName.get(x.b)??x.b,
      games:x.games,w:x.w,d:x.d,l:x.l,
      winRate,expected,synergy
    };
  });

  const matchIdSet = new Set(matchIds);
const eventSynergy = buildEventSynergy(RAW_EVENT_ROWS, matchIdSet);

// Attach event synergy to existing pairList
for (const p of pairList) {
  const key =
    p.a_id < p.b_id
      ? `${p.a_id}||${p.b_id}`
      : `${p.b_id}||${p.a_id}`;

  p.eventSynergy = eventSynergy.get(key) || 0;
}

  const captainList=Array.from(captainById.values()).map(c=>({
    player_id:c.player_id,
    player_name:c.player_name,
    games:c.games,
    w:c.w,d:c.d,l:c.l,
    winRate:c.games?c.w/c.games:0
  }));

  return {matchSummaries,baseWinRate,base,playerList,pairList,captainList};
}

function renderKPIs(model){
  const sundays=model.matchSummaries.length;
  const trackedMatches = model.matchSummaries.filter(m => {
        const _totalGoals = m.totalGoals

        // Exclude untracked / partial-score games
        if (
          (_totalGoals === 1) ||
          (_totalGoals === 2)
        ) {
          return false;
        }
        return true;
      });

  const avgGoals = trackedMatches.length ? trackedMatches.reduce((acc, m) => acc + (m.totalGoals), 0) / trackedMatches.length
  : 0;
  const drawRate=model.base.teamGames?model.base.draws/model.base.teamGames:0;
  const closeRate=sundays?model.matchSummaries.filter(m=>m.close).length/sundays:0;

  // Best streak KPI (best win streak within selected filter)
  const list = model.playerList || [];
  const best = list.reduce((m,p)=>Math.max(m, p.bestStreak||0), 0);
  const winners = list.filter(p=>(p.bestStreak||0)===best && best>0);

  // Find most recent best streak end date among winners
  let bestEndDate = null;
  let bestEndKey = -Infinity;

  for (const p of winners) {
    const d = p.bestStreakEndDate;
    const k = dateKey(d);
    if (d && k > bestEndKey) {
      bestEndKey = k;
      bestEndDate = d;
    }
  }

  const kpiEl=document.getElementById("kpiBestStreak");
  const detEl=document.getElementById("kpiBestStreakDetail");
  if(kpiEl && detEl){
    if(best===0 || winners.length===0){
      kpiEl.textContent = "‚Äî";
      detEl.textContent = "No win streaks yet";
    }  else {
        const names = winners.map(p=>p.player_name).join(", ");
        kpiEl.textContent = `${names}: ${best} Win(s)`;
        detEl.textContent = bestEndDate
          ? `Last achieved: ${bestEndDate}`
          : "";
      }
  }

(function renderTopScorers(model){
  const ul = document.getElementById("kpiTopScorers");
  const det = document.getElementById("kpiTopScorersDetail");
  if (!ul || !det) return;

  const players = (model.playerList || [])
    .filter(p => (p.evGoals || 0) > 0)
    .sort((a,b) => b.evGoals - a.evGoals);

  if (!players.length) {
    ul.innerHTML = `<li class="rank-2">‚Äî No goals in this filter</li>`;
    det.textContent = "";
    return;
  }

  const medals = ["ü•á","ü•à","ü•â"];
  const top3 = players.slice(0,3);

  ul.innerHTML = top3.map((p, i) => `
    <li class="rank-${i+1}">
      <span class="medal">${medals[i]}</span>
      <span>${p.player_name}</span>
      <span>(${p.evGoals})</span>
    </li>
  `).join("");

  det.textContent = "";
})(CURRENT_MODEL);

  (function renderTopAssist(model){
    const el = document.getElementById("kpiTopAssist");
    const det = document.getElementById("kpiTopAssistDetail");
    if (!el || !det) return;

    const players = (model.playerList || [])
      .filter(p => (p.evAssists || 0) > 0)
      .sort((a,b) => b.evAssists - a.evAssists);

    if (!players.length) {
      el.textContent = "‚Äî";
      det.textContent = "No assists in this filter";
      return;
    }

    const top = players[0];

    el.textContent = `${top.player_name} (${top.evAssists})`;
  })(CURRENT_MODEL);

  setText("kpiSundays",String(sundays));
  setText("kpiAvgGoals",fmt(avgGoals,2));
  setText("kpiDrawRate",pct0(drawRate));
  setText("kpiClose",pct0(closeRate));
}

function renderCaptainKPI(model){
  const listEl=document.getElementById("kpiCaptainList");
  const emptyEl=document.getElementById("kpiCaptainEmpty");
  if(!listEl||!emptyEl) return;

  const list = (model?.captainList||[]).filter(c=>c.games>=MIN_CAPTAIN_GAMES);
  if(list.length===0){
    emptyEl.textContent = `No captains with ‚â• ${MIN_CAPTAIN_GAMES} games`;
    listEl.innerHTML = "";
    return;
  }

  emptyEl.textContent = "";

  const rows = [...list].sort((a, b) => {
      const wrA = a.games ? a.w / a.games : 0;
      const wrB = b.games ? b.w / b.games : 0;

      if (wrB !== wrA) return wrB - wrA;          // üî• highest win% first
      if (b.games !== a.games) return b.games - a.games; // tie-breaker: more games
      return a.player_name.localeCompare(b.player_name);
    });

  listEl.innerHTML = rows.map(r=>{
    const wr = r.games ? (r.w/r.games) : 0;
    const wrCls = clsSign(wr-0.5);
    return `
      <div class="row" style="justify-content:space-between; gap:8px;">
        <span style="font-weight:700; font-size:13px;">${r.player_name}</span>
        <span class="mono" title="Captain record (W-D-L) and win% within the selected filter.">
          <span class="badge ${wrCls}">${r.w}-${r.d}-${r.l}</span>
          <span class="small" style="margin-left:6px;">${pct0(wr)}</span>
        </span>
      </div>
    `;
  }).join("");
}

function renderMatchesTable(model){
  const table=document.getElementById("tblMatches");
  if(!table) return;

  const all=[...model.matchSummaries].sort((a,b)=>a.match_date<b.match_date?1:-1);

  const total=all.length;
  const totalPages=Math.max(1, Math.ceil(total / MATCHES_PAGE_SIZE));
  if(MATCHES_PAGE > totalPages-1) MATCHES_PAGE = totalPages-1;
  if(MATCHES_PAGE < 0) MATCHES_PAGE = 0;

  const start = MATCHES_PAGE * MATCHES_PAGE_SIZE;
  const end = Math.min(total, start + MATCHES_PAGE_SIZE);
  const pageRows = all.slice(start, end);

  // pager UI
  const label=document.getElementById("matchesPagerLabel");
  const pager=document.getElementById("matchesPager");
  if(label) label.textContent = total ? `Showing ${start+1}-${end} of ${total}` : "No matches";
  if(pager){
    if(total <= MATCHES_PAGE_SIZE){
      pager.innerHTML = "";
    } else {
      pager.innerHTML = `
        <button class="btn" id="mPrev" ${MATCHES_PAGE===0?"disabled":""} title="Newer">‚óÄ</button>
        <button class="btn" id="mNext" ${MATCHES_PAGE===totalPages-1?"disabled":""} title="Older">‚ñ∂</button>
      `;
      const prev=document.getElementById("mPrev");
      const next=document.getElementById("mNext");
      if(prev) prev.onclick = ()=>{ MATCHES_PAGE = Math.max(0, MATCHES_PAGE-1); renderMatchesTable(model); };
      if(next) next.onclick = ()=>{ MATCHES_PAGE = Math.min(totalPages-1, MATCHES_PAGE+1); renderMatchesTable(model); };
    }
  }

   // Precompute which matches have events (fast + safe)
  const eventMatchSet = new Set(
    Array.isArray(RAW_EVENT_ROWS)
      ? RAW_EVENT_ROWS.map(e => String(e.match_id ?? "").trim()).filter(Boolean)
      : []
  );

  table.innerHTML = `
    <thead><tr>
      <th title="Sunday date.">Date</th>
      <th title="Goals scored by Black.">‚¨õB.</th>
      <th title="Goals scored by White.">‚¨úW.</th>
      <th title="Top goal scorer in this match (from events file).">Top Scorer</th>
      <th title="Top assist provider in this match (from events file).">Top Assist</th>
      <th title="Black goals ‚àí White goals.">GD</th>
    </tr></thead>
    <tbody>
      ${pageRows.map(m => {
        const { scorer, assist } = getTopEventsForMatch(String(m.match_id));

        const blackCls =
          m.black_gf > m.white_gf ? "cell-win" :
          m.black_gf < m.white_gf ? "cell-loss" :
          "cell-draw";

        const whiteCls =
          m.white_gf > m.black_gf ? "cell-win" :
          m.white_gf < m.black_gf ? "cell-loss" :
          "cell-draw";

        const hasEvents = eventMatchSet.has(String(m.match_id));

        return `
          <tr class="${hasEvents ? "match-has-events" : ""}" data-match="${String(m.match_id)}">
            <td>${hasEvents ? "‚ÑπÔ∏è" : ""}${m.match_date}</td>
            <td class="${blackCls}">${m.black_gf}</td>
            <td class="${whiteCls}">${m.white_gf}</td>
            <td>${scorer}</td>
            <td>${assist}</td>
            <td>${m.gd_black}</td>
          </tr>
        `;
      }).join("")}
    </tbody>
  `;

  // Click to open modal (only rows with events)
  table.querySelectorAll("tr.match-has-events").forEach(tr => {
    tr.style.cursor = "pointer";
    tr.addEventListener("click", () => {
      const matchId = tr.dataset.match;
      openMatchModal(matchId, model);
    });
  });
}

function getTopEventsForMatch(matchId) {
  if (!Array.isArray(RAW_EVENT_ROWS)) {
    return { scorer: "‚Äî", assist: "‚Äî" };
  }

  const goals = {};
  const assists = {};

  for (const e of RAW_EVENT_ROWS) {
    if (e.match_id !== matchId) continue;

    if (e.goal_player_id) {
      goals[e.goal_player_id] = (goals[e.goal_player_id] || 0) + 1;
    }
    if (e.assist_player_id) {
      assists[e.assist_player_id] = (assists[e.assist_player_id] || 0) + 1;
    }
  }

  const topGoal = Object.entries(goals).sort((a,b) => b[1]-a[1])[0];
  const topAssist = Object.entries(assists).sort((a,b) => b[1]-a[1])[0];

  const scorer = topGoal ? `${topGoal[0]} (${topGoal[1]})` : "‚Äî";
  const assist = topAssist ? `${topAssist[0]} (${topAssist[1]})` : "‚Äî";

  return { scorer, assist };
}

function makeSortable(table,drawFn){
  let sortKey=null,sortDir=-1;
  table.querySelectorAll("th[data-key]").forEach(th=>th.addEventListener("click",()=>{
    const k=th.getAttribute("data-key");
    if(sortKey===k) sortDir*=-1;
    else { sortKey=k; sortDir=-1; }
    drawFn(sortKey,sortDir);
  }));
}

function renderPlayersTable(model){
  const minGamesEl = document.getElementById("minGames");

    // max games any player has in the current filter
    const maxGamesInSelection = Math.max(
      0,
      ...(model.playerList || []).map(p => p.games || 0)
    );

    // default logic: min(3, maxGamesInSelection)
    const defaultMinGames = Math.min(3, maxGamesInSelection);

   // If user has NOT explicitly set it, force the dropdown to the adaptive default
    if (minGamesEl && !minGamesEl.dataset.userSet) {
      minGamesEl.value = String(defaultMinGames);
    }

    // Now read the effective minGames
    const minGames = Number(minGamesEl?.value ?? String(defaultMinGames));

  const data=model.playerList
    .filter(p=>p.games>=minGames)
    .map(p=>({
      player_id:p.player_id,
      player_name:p.player_name,
      games:p.games,
      w:p.w,d:p.d,l:p.l,
      winRate:p.winRate,
      evGoals: p.evGoals || 0,
      evAssists: p.evAssists || 0,
      evSecondAssists: p.evSecondAssists || 0,
      goalsPro:p.totalGF,
      goalsAgainst:p.totalGA,
      goalDiff:p.totalGD,
      impact:p.impact,
      currentStreak:p.currentStreak,
      currentCold:p.currentCold
    }));

  const table=document.getElementById("tblPlayers");
  if(!table) return;

  table.innerHTML=`<thead><tr>
    <th data-key="player_name" title="Player name.">Player</th>
    <th data-key="games" title="Games played (within the selected filter).">GP</th>
    <th data-key="w" title="Wins.">W</th>
    <th data-key="d" title="Draws.">D</th>
    <th data-key="l" title="Losses.">L</th>
    <th data-key="winRate" title="Win% = wins / games played.">Win%</th>

    <!-- new data -->
    <th data-key="evGoals" title="Goals scored from match_events.csv.">G</th>
    <th data-key="evAssists" title="Assists from match_events.csv.">A</th>
    <th data-key="evSecondAssists" title="Secondary assists from match_events.csv.">2A</th>

    <th data-key="goalsPro" title="Goals Pro (TOTAL): total team goals scored in games the player played.">Goals Pro ‚öΩ</th>
    <th data-key="goalsAgainst" title="Goals Against (TOTAL): total team goals conceded in games the player played.">Goals Against üß§</th>
    <th data-key="goalDiff" title="Total goal difference: Goals Pro ‚àí Goals Against.">Goal Diff</th>
    <th data-key="impact" title="(Player win% ‚àí baseline win%) in percentage points.">Imp.</th>
    <th data-key="currentStreak" title="Current streak: üî• for win streak, ‚ùÑÔ∏è for loss streak.">Streak</th>
  </tr></thead><tbody></tbody>`;

  const tbody=table.querySelector("tbody");

  function draw(sortKey="winRate",sortDir=-1){
    data.sort((a,b)=>{
      const va=a[sortKey], vb=b[sortKey];
      if(typeof va==="string") return sortDir*va.localeCompare(vb);
      return sortDir*((va??0)-(vb??0));
    });

    tbody.innerHTML=data.map(r=>{
      const gdCls=clsSign(r.goalDiff);
      const impCls=clsSign(r.impact);
      return `<tr data-player="${r.player_id}">
        <td>${r.player_name}</td>
        <td>${r.games}</td>
        <td>${r.w}</td>
        <td>${r.d}</td>
        <td>${r.l}</td>
        <td><span class="badge ${clsSign(r.winRate-0.5)}">${pct0(r.winRate)}</span></td>
        <td>${r.evGoals}</td>
        <td>${r.evAssists}</td>
        <td>${r.evSecondAssists}</td>
        <td>${r.goalsPro}</td>
        <td>${r.goalsAgainst}</td>
        <td><span class="${gdCls}">${signedNum(r.goalDiff)}</span></td>
        <td><span class="${impCls}">${signedPP(r.impact)}</span></td>
        <td>${
          r.currentStreak>0
            ? `<span class="badge pos" title="Current win streak (wins in a row).">üî•${r.currentStreak}</span>`
            : (r.currentCold>0
                ? `<span class="badge neg" title="Current loss streak (losses in a row).">‚ùÑÔ∏è${r.currentCold}</span>`
                : "")
        }</td>
      </tr>`;
    }).join("");

    tbody.querySelectorAll("tr[data-player]").forEach(tr =>
      tr.addEventListener("click", () => {
        const pid = tr.getAttribute("data-player");
        const sel = document.getElementById("playerSelect");
        if (sel) sel.value = pid;

        PROFILE_PAGE_BY_PLAYER.delete(pid);
        renderPlayerProfile(model, pid);

        // ‚úÖ Scroll to Player Profile
        const profile = document.getElementById("playerProfileCard");
        if (profile) {
          profile.scrollIntoView({
            behavior: "smooth",
            block: "start"
          });
        }
      })
      );
  }

  makeSortable(table,draw);
  draw("winRate",-1);

  CURRENT_MODEL.playerNameIndex = buildPlayerIndex(CURRENT_MODEL.playerList);

}

function playerExists(name){
  if (!name) return false;
  return CURRENT_MODEL?.playerNameIndex?.has(name) ?? false;
}

function buildPlayerIndex(playerList){
  const set = new Set();
  for (const p of playerList || []) {
    if (p?.player_name) {
      set.add(normPid(p.player_name));
    }
  }
  return set;
}

function renderPlayerSelect(model){
  const sel=document.getElementById("playerSelect");
  if(!sel) return;
  const sorted=[...model.playerList].sort((a,b)=>a.player_name.localeCompare(b.player_name));
  sel.innerHTML=sorted.map(p=>`<option value="${p.player_id}">${p.player_name}</option>`).join("");
  sel.onchange=()=>{
    const pid=sel.value;
    PROFILE_PAGE_BY_PLAYER.delete(pid);
    renderPlayerProfile(model,pid);
  };
  if(sorted[0]){
    PROFILE_PAGE_BY_PLAYER.delete(sorted[0].player_id);
    renderPlayerProfile(model,sorted[0].player_id);
  }
}

function renderPlayerProfile(model,playerId){
  const p=model.playerList.find(x=>x.player_id===playerId);
  if(!p) return;

  if(!PROFILE_PAGE_BY_PLAYER.has(playerId)) PROFILE_PAGE_BY_PLAYER.set(playerId,0);
  let page = PROFILE_PAGE_BY_PLAYER.get(playerId) || 0;

  setText("pWDL",`${p.w}-${p.d}-${p.l}`);
  setText("pWR",`${emojiSign(p.winRate-0.5)} ${pct0(p.winRate)}`);
  setText("pSessions",String(p.sessionsPlayedAll||0));

  const row=document.getElementById("pStreakRow");
  if(row){
    const items=[];
    if(p.currentStreak>0) items.push(`<span class="badge pos" title="Current winning streak.">üî• Current W: ${p.currentStreak}</span>`);
    if(p.bestStreak>0) items.push(`<span class="badge pos" title="Best win streak.">üèÜ Best W: ${p.bestStreak}</span>`);
    if(p.currentCold>0) items.push(`<span class="badge neg" title="Current loss streak.">‚ùÑÔ∏è Current L: ${p.currentCold}</span>`);
    if(p.bestCold>0) items.push(`<span class="badge neg" title="Worst loss streak.">üßä Worst L: ${p.bestCold}</span>`);
    row.innerHTML = items.length ? items.join("") : `<span class="small">No active streaks</span>`;
  }

  
  // --- Event stats (from match_events.csv)
  const goals = p.evGoals || 0;
  const assists = p.evAssists || 0;
  const secondAssists = p.evSecondAssists || 0;
  const games = p.games || 0;
  const evGames = p.evGames || 0;

  const elImp=document.getElementById("pImpact");
  if(elImp) elImp.className=clsSign(p.impact);
  setText("pImpact",`${emojiSign(p.impact)} ${signedPP(p.impact)}`);
  
  // Team impact (team outcomes while player played)
    setText("pTeamGoals", `${p.totalGF} / ${p.totalGA}`);
    setText("pTeamGD",`${emojiSign(p.totalGD)} ${p.totalGD}`);
    setText(
      "pImpactNote",
      `Baseline win rate: ${pct0(model.baseWinRate)} ‚Ä¢ ` + `Player win rate: ${pct0(p.winRate)} ‚Ä¢ ` 
    );
      // Player actions (events)

      // Tracked games (shown next to title)
      setText("pEvGames", evGames ? String(evGames) : "0");

      // Goals
      setText("pEvGoals", String(goals));
      setText("pEvGoalsPg",evGames && goals > 0 ? perGame(goals, evGames) : "‚Äî");

      // Assists
      setText("pEvAssists", String(assists));
      setText("pEvAssistsPg",evGames && assists > 0 ? perGame(assists, evGames) : "‚Äî");

      // 2nd Assists
      setText("pEv2A", String(secondAssists));
      setText("pEv2APg",evGames && secondAssists > 0 ? perGame(secondAssists, evGames) : "‚Äî");


  const capCard=document.getElementById("pCaptainCard");
  const capRow=document.getElementById("pCaptainRow");
  if(capCard && capRow){
    if((p.captainGames||0)===0){
      capCard.style.display="none";
    } else {
      capCard.style.display="block";
      const wr=p.captainGames? (p.captainW/p.captainGames):0;
      capRow.innerHTML = `
        <span class="badge" title="Games where this player was captain."> Games: ${p.captainGames}</span>
        <span class="badge pos" title="Wins as captain.">W: ${p.captainW}</span>
        <span class="badge neu" title="Draws as captain.">D: ${p.captainD}</span>
        <span class="badge neg" title="Losses as captain.">L: ${p.captainL}</span>
        <span class="badge ${clsSign(wr-0.5)}" title="Win% as captain.">Win%: ${pct0(wr)}</span>
      `;
    }
  }

  const total=p.timeline.length;
  const totalPages = Math.max(1, Math.ceil(total/PROFILE_PAGE_SIZE));
  if(page > totalPages-1) page = totalPages-1;
  if(page < 0) page = 0;
  PROFILE_PAGE_BY_PLAYER.set(playerId,page);

  const start=page*PROFILE_PAGE_SIZE;
  const end=Math.min(total,start+PROFILE_PAGE_SIZE);
  const slice=p.timeline.slice(start,end);

  const controls=document.getElementById("pTimelineControls");
  if(controls){
    if(total<=PROFILE_PAGE_SIZE){
      controls.innerHTML="";
    } else {
      const prevDisabled = page===0 ? "disabled" : "";
      const nextDisabled = page===totalPages-1 ? "disabled" : "";
      controls.innerHTML = `
        <span class="small" title="Showing ${start+1}-${end} of ${total}">#${start+1}-${end}/${total}</span>
        <button class="btn" id="pPrev" ${prevDisabled} title="Previous (newer)">‚óÄ</button>
        <button class="btn" id="pNext" ${nextDisabled} title="Next (older)">‚ñ∂</button>
      `;
      const prev=document.getElementById("pPrev");
      const next=document.getElementById("pNext");
      if(prev) prev.onclick=()=>{PROFILE_PAGE_BY_PLAYER.set(playerId,Math.max(0,page-1)); renderPlayerProfile(model,playerId);};
      if(next) next.onclick=()=>{PROFILE_PAGE_BY_PLAYER.set(playerId,Math.min(totalPages-1,page+1)); renderPlayerProfile(model,playerId);};
    }
  }

  const timelineEl=document.getElementById("pTimeline");
  if(timelineEl){
    timelineEl.innerHTML = slice
    .map(t => {
      const cls =
        t.res === "W" ? "game-win" :
        t.res === "D" ? "game-draw" :
        t.res === "L" ? "game-loss" : "";

      return `<div>${t.match_date} | ${String(t.team).padEnd(5)} | <span class="${cls}">${t.res}</span> | ${t.gf}-${t.ga}</div>`;
    })
    .join("") || "‚Äî";
  }
  
 
  const mode = document.getElementById("viewMode")?.value || "all";
  const achCard = document.getElementById("playerAchievementsCard");

  if (achCard) {
    achCard.style.display = (mode === "all") ? "" : "none";
    if (hasQueryFlag("mock")) {
      achCard.style.display = "block";
    }
  }

  renderAchievements(p);
}

function renderPairsTable(model){
  // Populate dropdown the same way as Player Profile
  const sel = document.getElementById("pairPlayer");
  if(sel){
    const prev = sel.value;
    const sorted = [...model.playerList]
      .sort((a,b)=>a.player_name.localeCompare(b.player_name));

    sel.innerHTML =
      '<option value="">All players</option>' +
      sorted.map(p=>`<option value="${p.player_id}">${p.player_name}</option>`).join("");

    // keep selection if still valid
    if(prev && sorted.some(p=>p.player_id===prev)) sel.value = prev;
    else sel.value = "";
  }

  const minPair = Number(document.getElementById("minPairGames")?.value || "5");
  const playerId = document.getElementById("pairPlayer")?.value || "";
  const playerName = playerId
    ? (model.playerList.find(p=>p.player_id===playerId)?.player_name || playerId)
    : "";

  const data = model.pairList
    .filter(x => x.games >= minPair)
    .filter(x => pairMatchesPlayer(x.a_id, x.b_id, playerId));

  const table=document.getElementById("tblPairs");
  if(!table) return;

  table.innerHTML=`<thead><tr>
    <th data-key="a_name" title="First player.">Player A</th>
    <th data-key="b_name" title="Second player.">Player B</th>
    <th data-key="games" title="Games together.">GP</th>
    <th data-key="winRate" title="Win% when together (wins / games).">Win%</th>
    <th data-key="expected" title="Expected = avg of each player win%.">Exp.</th>
    <th data-key="synergy" title="Synergy = together win% ‚àí expected.">Synergy</th>
    <th data-key="w" title="Wins together.">W</th>
    <th data-key="l" title="Losses together.">L</th>
    <th  title="Scoring Together">Scoring Duo</th>
  </tr></thead><tbody></tbody>`;

  const tbody=table.querySelector("tbody");

  function draw(sortKey="synergy",sortDir=-1){
    const rows=[...data];
    rows.sort((a,b)=>{
      const va=a[sortKey], vb=b[sortKey];
      if(typeof va==="string") return sortDir*va.localeCompare(vb);
      return sortDir*((va??0)-(vb??0));
    });

    if(rows.length===0){
      const msg = `No pairs match this filter (min games: ${minPair}).`;
      tbody.innerHTML = `<tr><td colspan="9" class="small">${msg}</td></tr>`;
      return;
    }

    tbody.innerHTML=rows.map(r=>{
      const synCls=clsSign(r.synergy);
      return `<tr>
        <td>${r.a_name}</td>
        <td>${r.b_name}</td>
        <td>${r.games}</td>
        <td><span class="badge ${clsSign(r.winRate-0.5)}">${pct0(r.winRate)}</span></td>
        <td>${pct0(r.expected)}</td>
        <td><span class="${synCls}">${signedPP(r.synergy)}</span></td>
        <td>${r.w}</td>
        <td>${r.l}</td>
        <td>${r.eventSynergy}</td>
      </tr>`;
    }).join("");
  }

  makeSortable(table,draw);
  draw("synergy",-1);
}

function renderMatchTimeline(matchId){
  const wrap = document.querySelector(".timeline-wrap");
  const host = document.getElementById("matchTimelineEvents");
  if(!wrap || !host) return;

  const events = (Array.isArray(RAW_EVENT_ROWS) ? RAW_EVENT_ROWS : [])
    .filter(e => String(e.match_id ?? "").trim() === String(matchId));

  host.innerHTML = "";

  if(!events.length){
    host.innerHTML = `<div class="small" style="padding:10px; opacity:.8;">No event data for this match.</div>`;
    return;
  }

  // Determine start hour by rounding down the earliest event time to the hour.
  const mins = events
    .map(parseEventTimeToMinutes)
    .filter(v => typeof v === "number");

  const minT = mins.length ? Math.min(...mins) : null;
  const startMin = (minT != null) ? Math.floor(minT / 60) * 60 : 0;
  const duration = 120; // 2 hours

  // Sort events by time
  const enriched = events.map(e => {
    const t = parseEventTimeToMinutes(e);
    const offset = (t == null) ? null : (t - startMin);
    return { e, t, offset };
  }).sort((a,b) => (a.offset ?? 999999) - (b.offset ?? 999999));

    // --- NEW non-overlap logic ---
  const EVENT_GAP = 18; // px, must be >= label height
  let lastY = -Infinity;

  enriched.forEach(({e, offset}) => {
    const teamRaw = String(e.Team ?? e.team ?? "").trim().toLowerCase();
    const side = (teamRaw === "black") ? "left" : (teamRaw === "white") ? "right" : "left";

    const goal = String(e.goal_player_id ?? "").trim();
    const asst = String(e.assist_player_id ?? "").trim();

    const textParts = [];
    if(goal) textParts.push(`${goal} ‚öΩ`);
    if(asst) textParts.push(`${asst} üëü`);

    const minuteLabel =
      (typeof offset === "number" && offset >= 0)
        ? `${Math.floor(offset)}‚Ä≤ `
        : "";

    const label =
      minuteLabel +
      (textParts.length ? textParts.join(" ¬∑ ") : "Event");

    // Clamp within 0..120 for display
    const off = (typeof offset === "number")
      ? Math.max(0, Math.min(duration, offset))
      : 0;

    // Base percent position
    const pct = off / duration; // 0..1

    // Convert % to pixel Y
    const wrapH = wrap.clientHeight || 300; // fallback safety
    let y = pct * wrapH;

    // üîë GLOBAL non-overlap enforcement
    if (y < lastY + EVENT_GAP) {
      y = lastY + EVENT_GAP;
    }

    lastY = y;

    const div = document.createElement("div");
    div.className = `tl-event ${side === "left" ? "tl-left" : "tl-right"}`;
    div.style.top = `${y}px`;
    div.textContent = label;

    host.appendChild(div);
  });

}

function renderGDChart(model){
  const ms=[...model.matchSummaries].sort((a,b)=>a.match_date.localeCompare(b.match_date));
  const canvas=document.getElementById("chartGD");
  if(!canvas) return;
  drawBarChart(canvas, ms.map(m=>m.match_date.slice(5)), ms.map(m=>m.gd_black));
}

function renderAchievements(player){
  const el=document.getElementById("playerAchievements");
  if(!el) return;

  el.innerHTML = ACHIEVEMENTS.map(a=>{
    const val = a.value(player) || 0;
    const pct = Math.min(100, Math.round((val / a.target) * 100));
    const unlocked = val >= a.target;

    return `
      <div class="ach ${unlocked?"unlocked":"locked"}"
          onclick="showAchievement(
              '${a.title}',
              '${a.desc}\\nProgress: ${val}/${a.target}',
              '${a.icon}',
              '${a.id.includes("gold") ? "gold" : a.id.includes("silver") ? "silver" : "bronze"}'
            )">
        <img src="${a.icon}" alt="">
        <div class="ach-title">${a.title}</div>
        <div class="ach-bar">
          <div style="width:${pct}%"></div>
        </div>
      </div>
    `;
  }).join("");
}

function renderAll(model){
  renderKPIs(model);
  renderCaptainKPI(model);
  renderMatchesTable(model);
  renderPlayersTable(model);  
  renderPlayerSelect(model);
  renderPairsTable(model);
  renderGDChart(model);
  
  applyPlayerFilter();
}

async function readFileText(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(String(fr.result||""));
    fr.onerror=reject;
    fr.readAsText(file);
  });
}

function buildFilterIndex(matchRows){
  const sessions=new Set();
  const years=new Set();
  for(const r of matchRows){
    sessions.add(r.session_id);
    years.add(yearOf(r.match_date));
  }
  return {sessionList:[...sessions].sort(),yearList:[...years].sort()};
}

function getMostRecentSession(matchRows){
  let bestDate="", bestSession="S01";
  for(const r of matchRows){
    const d=String(r.match_date??"");
    const sid=String(r.session_id??"S01").trim()||"S01";
    if(d>bestDate){bestDate=d;bestSession=sid;}
    else if(d===bestDate && sid>bestSession){bestSession=sid;}
  }
  return bestSession;
}

function getMostRecentYear(matchRows){
  let best="0000";
  for(const r of matchRows){
    const y=yearOf(r.match_date);
    if(y>best) best=y;
  }
  return best;
}

function applyFilterAndRender(){
  if(!RAW_PLAYER_ROWS.length || !RAW_MATCH_ROWS.length) return;

  const mode=document.getElementById("viewMode")?.value || "all";
  const val=document.getElementById("viewValue")?.value || "";

  let fPlayers=RAW_PLAYER_ROWS;
  let fMatches=RAW_MATCH_ROWS;
  let tag="All history";

  if(mode==="session"){
    fPlayers=RAW_PLAYER_ROWS.filter(r=>String(r.session_id??"S01").trim()===val);
    fMatches=RAW_MATCH_ROWS.filter(r=>String(r.session_id??"S01").trim()===val);
    tag=`Session: ${val}`;
  } else if(mode==="year"){
    fPlayers=RAW_PLAYER_ROWS.filter(r=>yearOf(r.match_date)===val);
    fMatches=RAW_MATCH_ROWS.filter(r=>yearOf(r.match_date)===val);
    tag=`Year: ${val}`;
  }

  const tagEl=document.getElementById("activeFilterTag");
  if(tagEl){
    tagEl.textContent=`Filter: ${tag}`;
    tagEl.title=`Active filter: ${tag}`;
  }

  MATCHES_PAGE = 0;
  CURRENT_MODEL=buildModel(fPlayers,fMatches,ALLTIME_SESSIONS_BY_PLAYER);

  // Attach event-based stats (goals/assists/2nd assists) if events are loaded
  //const matchIdSet = new Set((CURRENT_MODEL.matchSummaries || []).map(m => m.match_id));
  const matchIdSet = new Set(
   (CURRENT_MODEL.matchSummaries || []).map(m => String(m.match_id).trim())
   );
  const eventAgg = buildEventAgg(RAW_EVENT_ROWS || [], matchIdSet);

  // Matches in the current filter that actually have event data
    const eventMatchIdSet = new Set(
      (RAW_EVENT_ROWS || [])
        .filter(e => matchIdSet.has(String(e.match_id).trim()))
        .map(e => e.match_id)
    );

    // Count event-games per player USING FILTERED DATA
    const eventGamesByPlayer = new Map();

    for (const p of CURRENT_MODEL.playerList || []) {
      const evGames = (p.timeline || []).filter(t =>
        eventMatchIdSet.has(String(t.match_id).trim())
      ).length;

      eventGamesByPlayer.set(p.player_id, evGames);
    }

    (CURRENT_MODEL.playerList || []).forEach(p => {
      const pid = normPid(p.player_id);
      const a = eventAgg.get(pid) || {goals:0,assists:0,secondAssists:0};

      p.evGoals = a.goals;
      p.evAssists = a.assists;
      p.evSecondAssists = a.secondAssists;
      p.evGames = eventGamesByPlayer.get(p.player_id) || 0;
    });
  renderAll(CURRENT_MODEL);
  }

function on(id,evt,fn){
  const el=document.getElementById(id);
  if(el) el.addEventListener(evt,fn);
}

//try{runSelfTests()}catch(e){console.error(e)}

on("useMock","click",loadFromMock);
on("loadFiles","click",loadFromUploads);
on("minGames","change",e=>{
  e.target.dataset.userSet = "1";
  CURRENT_MODEL && renderPlayersTable(CURRENT_MODEL);
});
on("minPairGames","change",()=>CURRENT_MODEL&&renderPairsTable(CURRENT_MODEL));
on("pairPlayer","change",()=>CURRENT_MODEL && renderPairsTable(CURRENT_MODEL));
on("viewMode","change",refreshViewControls);
on("viewValue","change",applyFilterAndRender);

(function initTheme(){
  const root=document.documentElement;
  const saved=localStorage.getItem("soccer_theme");
  if(saved==="light"||saved==="dark") root.dataset.theme=saved;
  const label=document.getElementById("themeLabel");
  function syncLabel(){ if(label) label.textContent=(root.dataset.theme==="light")?"Light":"Dark" }
  syncLabel();
  on("themeToggle","click",()=>{
    const next=(root.dataset.theme==="light")?"dark":"light";
    root.dataset.theme=next;
    localStorage.setItem("soccer_theme",next);
    syncLabel();
    if(CURRENT_MODEL) renderGDChart(CURRENT_MODEL);
  });
})();

(function toggleDataPanel(){
  const panel = document.getElementById("dataPanel");
  if (!panel) return;

  if (hasQueryFlag("mock")) {
    panel.style.display = "block";
  }

  const achievements = document.getElementById("playerAchievementsCard");
  if (!achievements) return;

  if (hasQueryFlag("mock")) {
    achievements.style.display = "block";
  }
})();

function buildEventSynergy(eventRows, matchIdSet){
  const synergy = new Map();

  for (const e of eventRows || []) {
    if (!matchIdSet.has(String(e.match_id).trim())) continue;

    const players = new Set();
    if (e.goal_player_id) players.add(normPid(e.goal_player_id));
    if (e.assist_player_id) players.add(normPid(e.assist_player_id));
    if (e.second_assist_player_id) players.add(normPid(e.second_assist_player_id));

    const list = Array.from(players);
    if (list.length < 2) continue;

    for (let i = 0; i < list.length; i++) {
      for (let j = i + 1; j < list.length; j++) {
        const a = list[i];
        const b = list[j];
        const key = a < b ? `${a}||${b}` : `${b}||${a}`;
        synergy.set(key, (synergy.get(key) || 0) + 1);
      }
    }
  }

  return synergy;
}

function showAchievement(title, desc, icon, rarity){
  const overlay = document.getElementById("achModalOverlay");
  const modal   = overlay?.querySelector(".ach-modal");
  const titleEl = document.getElementById("achModalTitle");
  const bodyEl  = document.getElementById("achModalBody");
  const iconEl  = document.getElementById("achModalIcon");

  if(!overlay || !modal || !titleEl || !bodyEl || !iconEl) return;

  titleEl.textContent = title;
  bodyEl.textContent  = desc;
  iconEl.src = icon;

  modal.classList.remove("bronze","silver","gold");
  if(rarity) modal.classList.add(rarity);

  overlay.style.display = "flex";
}

function closeAchievementModal(){
  const overlay = document.getElementById("achModalOverlay");
  if(overlay) overlay.style.display = "none";
}

document.getElementById("achModalOverlay")?.addEventListener("click", e=>{
  if(e.target.id === "achModalOverlay") closeAchievementModal();
});

document.addEventListener("keydown", e=>{
  if(e.key === "Escape") closeAchievementModal();
});

function closeMatchModal(){
  const overlay = document.getElementById("matchModalOverlay");
  if(overlay) overlay.style.display = "none";
}

document.getElementById("matchModalOverlay")?.addEventListener("click", e=>{
  if(e.target.id === "matchModalOverlay") closeMatchModal();
});

document.addEventListener("keydown", e=>{
  if(e.key === "Escape") closeMatchModal();
});

function openMatchModal(matchId, model){
  const overlay = document.getElementById("matchModalOverlay");
  const titleEl = document.getElementById("matchModalTitle");
  const subEl   = document.getElementById("matchModalSub");
  if(!overlay || !titleEl || !subEl) return;

  const m = (model?.matchSummaries || []).find(x => String(x.match_id) === String(matchId));

  titleEl.textContent = m ? `${m.match_date} ¬∑ Black ${m.black_gf}‚Äì${m.white_gf} White` : `Match ${matchId}`;
  subEl.textContent   = m ? `Session ${m.session_id || "‚Äî"} ¬∑ Match ${m.match_id}` : "‚Äî";

  renderMatchTimeline(matchId);

  overlay.style.display = "flex";
}

function parseEventTimeToMinutes(e){
  // Supports: "12/28/2025 19:14" OR "19:14" OR "7:14 PM"
  const raw = String(e.Timestamp ?? e.timestamp ?? e.time ?? "").trim();
  if(!raw) return null;

  // Try "MM/DD/YYYY HH:MM"
  const m1 = raw.match(/(\d{1,2}):(\d{2})/);
  if(!m1) return null;

  let hh = parseInt(m1[1], 10);
  const mm = parseInt(m1[2], 10);

  // Handle AM/PM if present
  if (/pm/i.test(raw) && hh < 12) hh += 12;
  if (/am/i.test(raw) && hh === 12) hh = 0;

  return hh * 60 + mm;
}


/***ACHIEVEMENTS END CODE *****/
</script>
  <div id="achModalOverlay" class="ach-modal-overlay" style="display:none">
    <div class="ach-modal">
      <div class="ach-modal-header">
        <span id="achModalTitle"></span>
        <button class="ach-modal-close" onclick="closeAchievementModal()">‚úï</button>
      </div>

      <div class="ach-modal-body">
        <img id="achModalIcon" class="ach-modal-icon" />
        <div id="achModalBody"></div>
      </div>
    </div>
  </div>

  <!--timeline for modal-->
  <div id="matchModalOverlay" class="match-modal-overlay" style="display:none">
    <div class="match-modal">
      <div class="match-modal-header">
        <div>
          <div id="matchModalTitle" style="font-weight:900;">Match</div>
          <div id="matchModalSub" class="small" style="opacity:.85;">‚Äî</div>
        </div>
        <button class="match-modal-close" onclick="closeMatchModal()">‚úï</button>
      </div>

      <div class="match-modal-body">
        <div class="timeline-wrap">
          <!-- Team headers -->
          <div class="timeline-headers">
            <div class="timeline-header left">Black</div>
            <div class="timeline-header right">White</div>
          </div>

          <div class="timeline-line"></div>
          <div id="matchTimelineEvents"></div>
        </div>
        <div class="small" style="opacity:.8; margin-top:8px;">
          Timeline represents 2 hours. Top = start, bottom = end.
        </div>
      </div>
    </div>
  </div>

</body>
</html>
	